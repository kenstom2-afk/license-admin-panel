<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-key text-2xl"></i>
                    <h1 class="text-xl font-bold">License Admin Panel</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i> Đăng xuất
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Tổng License</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalLicenses">0</h3>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-key text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">License Active</p>
                        <h3 class="text-3xl font-bold text-green-600 mt-2" id="activeLicenses">0</h3>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">License Inactive</p>
                        <h3 class="text-3xl font-bold text-yellow-600 mt-2" id="inactiveLicenses">0</h3>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-pause-circle text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">API Keys</p>
                        <h3 class="text-3xl font-bold text-purple-600 mt-2" id="activeApiKeys">0</h3>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-code text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-xl shadow mb-8">
            <div class="border-b border-gray-200">
                <nav class="flex">
                    <button onclick="switchTab('licenses')" class="tab-btn active px-6 py-4 font-medium text-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-key mr-2"></i> License
                    </button>
                    <button onclick="switchTab('apikeys')" class="tab-btn px-6 py-4 font-medium text-gray-500 hover:text-gray-700">
                        <i class="fas fa-code mr-2"></i> API Keys
                    </button>
                </nav>
            </div>
            
            <!-- Licenses Tab -->
            <div id="tabLicensesContent" class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Quản lý License</h2>
                    <button onclick="createLicense()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-plus mr-2"></i> Tạo License
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchLicense" placeholder="Tìm kiếm license..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">License Key</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sản phẩm</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng thái</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="licenseTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex justify-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    </div>
                                    <p class="mt-2">Đang tải dữ liệu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- API Keys Tab -->
            <div id="tabApiKeysContent" class="p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Quản lý API Keys</h2>
                    <button onclick="createApiKey()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center">
                        <i class="fas fa-plus mr-2"></i> Tạo API Key
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="apiKeysList">
                    <div class="text-center text-gray-500 py-8">
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                        </div>
                        <p class="mt-2">Đang tải API Keys...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-info-circle"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            toast.className = `fixed top-4 right-4 ${colors[type] || 'bg-gray-800'} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50`;
            icon.className = `fas ${icons[type] || 'fa-info-circle'}`;
            msg.textContent = message;
            
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }
        
        // Tabs
        function switchTab(tab) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });
            
            event.target.classList.add('active', 'text-blue-600', 'border-blue-600');
            
            // Update content
            document.getElementById('tabLicensesContent').classList.add('hidden');
            document.getElementById('tabApiKeysContent').classList.add('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Content').classList.remove('hidden');
            
            if (tab === 'apikeys') {
                loadApiKeys();
            }
        }
        
        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalLicenses').textContent = data.data.total_licenses;
                    document.getElementById('activeLicenses').textContent = data.data.active_licenses;
                    document.getElementById('inactiveLicenses').textContent = data.data.inactive_licenses;
                    document.getElementById('activeApiKeys').textContent = data.data.active_api_keys;
                }
            } catch (error) {
                console.error('Stats error:', error);
            }
        }
        
        // Load licenses
        async function loadLicenses() {
            try {
                const tbody = document.getElementById('licenseTableBody');
                const response = await fetch('/api/admin/licenses');
                const data = await response.json();
                
                if (data.success) {
                    tbody.innerHTML = '';
                    
                    if (data.data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                    <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
                                    <p>Chưa có license nào</p>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.data.forEach(license => {
                        let statusColor = '';
                        switch(license.status) {
                            case 'active': statusColor = 'bg-green-100 text-green-800'; break;
                            case 'inactive': statusColor = 'bg-yellow-100 text-yellow-800'; break;
                            case 'expired': statusColor = 'bg-red-100 text-red-800'; break;
                            default: statusColor = 'bg-gray-100 text-gray-800';
                        }
                        
                        const row = `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <div class="font-mono text-sm">${license.license_key}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-sm">${license.product}</div>
                                    <div class="text-xs text-gray-500">${license.owner || 'Không có'}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs font-medium ${statusColor} rounded-full">
                                        ${license.status}
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <button onclick="deleteLicense(${license.id})" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition text-sm">
                                        <i class="fas fa-trash mr-1"></i> Xóa
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error('Licenses error:', error);
                const tbody = document.getElementById('licenseTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Lỗi khi tải dữ liệu</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Create license
        async function createLicense() {
            const product = prompt('Nhập tên sản phẩm:');
            if (!product) return;
            
            const days = prompt('Nhập số ngày (mặc định 30):', '30');
            if (!days) return;
            
            try {
                const response = await fetch('/api/admin/licenses/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product: product,
                        custom_days: parseInt(days)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Đã tạo license: ${data.license_key}`, 'success');
                    await loadLicenses();
                    await loadStats();
                } else {
                    showToast(data.message || 'Lỗi khi tạo license', 'error');
                }
            } catch (error) {
                console.error('Create license error:', error);
                showToast('Lỗi kết nối server', 'error');
            }
        }
        
        // Delete license
        async function deleteLicense(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa license này?')) return;
            
            try {
                const response = await fetch(`/api/admin/licenses/delete/${id}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Đã xóa license', 'success');
                    await loadLicenses();
                    await loadStats();
                } else {
                    showToast(data.message || 'Lỗi khi xóa license', 'error');
                }
            } catch (error) {
                console.error('Delete license error:', error);
                showToast('Lỗi kết nối server', 'error');
            }
        }
        
        // API Keys
        async function loadApiKeys() {
            try {
                const container = document.getElementById('apiKeysList');
                const response = await fetch('/api/admin/apikeys');
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = '';
                    
                    if (data.data.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-3 text-center text-gray-500 py-8">
                                <i class="fas fa-key text-4xl mb-2 text-gray-300"></i>
                                <p>Chưa có API Key nào</p>
                            </div>
                        `;
                        return;
                    }
                    
                    data.data.forEach(key => {
                        const card = `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold">${key.name}</h4>
                                        <div class="text-xs ${key.status === 'active' ? 'text-green-600' : 'text-red-600'}">
                                            ${key.status === 'active' ? 'Active' : 'Inactive'}
                                        </div>
                                    </div>
                                    <button onclick="deleteApiKey(${key.id})" class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div class="flex items-center space-x-2">
                                        <code class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded text-gray-800 font-mono text-xs break-all">
                                            ${key.key}
                                        </code>
                                        <button onclick="copyToClipboard('${key.key}')" class="px-2 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += card;
                    });
                }
            } catch (error) {
                console.error('API Keys error:', error);
            }
        }
        
        async function createApiKey() {
            const name = prompt('Nhập tên cho API Key:');
            if (!name) return;
            
            try {
                const response = await fetch('/api/admin/apikeys/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`API Key đã được tạo:\n\n${data.api_key}\n\n⚠️ Lưu lại ngay vì sẽ không hiển thị lại!`);
                    await loadApiKeys();
                    await loadStats();
                } else {
                    showToast(data.message || 'Lỗi khi tạo API Key', 'error');
                }
            } catch (error) {
                console.error('Create API key error:', error);
                showToast('Lỗi kết nối server', 'error');
            }
        }
        
        async function deleteApiKey(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa API Key này?')) return;
            
            try {
                const response = await fetch(`/api/admin/apikeys/delete/${id}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Đã xóa API Key', 'success');
                    await loadApiKeys();
                    await loadStats();
                } else {
                    showToast(data.message || 'Lỗi khi xóa API Key', 'error');
                }
            } catch (error) {
                console.error('Delete API key error:', error);
                showToast('Lỗi kết nối server', 'error');
            }
        }
        
        // Utility
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Đã sao chép', 'success');
            }).catch(err => {
                showToast('Không thể sao chép', 'error');
            });
        }
        
        async function logout() {
            if (!confirm('Bạn có chắc chắn muốn đăng xuất?')) return;
            
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadStats();
            await loadLicenses();
            
            // Auto refresh stats
            setInterval(loadStats, 30000);
            
            // Search
            const searchInput = document.getElementById('searchLicense');
            searchInput.addEventListener('input', function() {
                // Simple search implementation
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#licenseTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        });
    </script>
</body>
</html>
