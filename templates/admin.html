<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
        }
        
        body { 
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        .sidebar { 
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            border-right: 1px solid #334155;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.3);
        }
        
        .nav-link { 
            color: #94a3b8;
            border-radius: 8px;
            margin: 2px 10px;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link.active { 
            color: #ffffff;
            background-color: #334155;
            transform: translateX(5px);
        }
        
        .stat-card { 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .stat-card:hover { 
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }
        
        .license-key { 
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid var(--success-color);
        }
        
        .badge-custom { 
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .table-dark-custom {
            background: #1e293b;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table-dark-custom th {
            background: #334155;
            border: none;
            color: #cbd5e1;
            font-weight: 600;
            padding: 15px;
        }
        
        .table-dark-custom td {
            border-color: #334155;
            padding: 12px 15px;
            vertical-align: middle;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .modal-content {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
        }
        
        .form-control, .form-select {
            background-color: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            border-radius: 8px;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #334155;
            border-color: var(--primary-color);
            color: #e2e8f0;
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        pre {
            background: #0f172a;
            color: #7dd3fc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 0.9em;
        }
        
        code {
            color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .status-locked {
            background: rgba(247, 37, 133, 0.2);
            color: #f72585;
            border: 1px solid rgba(247, 37, 133, 0.3);
        }
        
        .status-expired {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .glow {
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.3);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky pt-4">
                    <div class="px-3 mb-4">
                        <h4 class="text-white mb-0">
                            <i class="bi bi-shield-lock-fill me-2" style="color: #4cc9f0;"></i> 
                            <span style="background: linear-gradient(90deg, #4cc9f0, #4361ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                License Admin
                            </span>
                        </h4>
                        <small class="text-muted">Professional License Management</small>
                    </div>
                    
                    <hr class="bg-secondary mx-3 my-4">
                    
                    <ul class="nav flex-column">
                        <li class="nav-item mb-2">
                            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                                <i class="bi bi-speedometer2 me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#" onclick="showSection('licenses')">
                                <i class="bi bi-key me-2"></i> Manage Licenses
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#" onclick="showSection('createLicense')">
                                <i class="bi bi-plus-circle me-2"></i> Create License
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#" onclick="showSection('apiKeys')">
                                <i class="bi bi-terminal me-2"></i> API Keys
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#" onclick="showSection('clientApi')">
                                <i class="bi bi-phone me-2"></i> Client API
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-5 px-3">
                        <div class="text-light small">
                            <div class="mb-2">API Endpoint:</div>
                            <code id="apiEndpoint" class="bg-dark text-light p-2 rounded d-block"></code>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Login Section -->
                <div id="loginSection" class="login-container">
                    <div class="card shadow-lg glow">
                        <div class="card-header" style="background: linear-gradient(135deg, #4361ee, #3a0ca3);">
                            <h4 class="mb-0 text-white"><i class="bi bi-lock-fill me-2"></i> Admin Login</h4>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <strong><i class="bi bi-info-circle me-2"></i> Default credentials:</strong><br>
                                Username: <code>admin</code><br>
                                Password: <code>admin123</code>
                            </div>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary-custom w-100">
                                    <i class="bi bi-box-arrow-in-right me-2"></i> Login
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Main Sections (hidden initially) -->
                <div id="mainSections" style="display: none;">
                    <!-- Header -->
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-3 mb-4 border-bottom border-secondary">
                        <h1 id="sectionTitle" class="h2">Dashboard</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshStats()">
                                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="logout()">
                                <i class="bi bi-box-arrow-right me-1"></i> Logout
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard -->
                    <div id="dashboardSection">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="card-title text-muted mb-2">Total Licenses</h5>
                                                <h2 id="totalLicenses" class="display-6 text-white">0</h2>
                                            </div>
                                            <i class="bi bi-key-fill display-6" style="color: #4361ee;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="card-title text-muted mb-2">Active</h5>
                                                <h2 id="activeLicenses" class="display-6 text-white">0</h2>
                                            </div>
                                            <i class="bi bi-check-circle-fill display-6" style="color: #4cc9f0;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="card-title text-muted mb-2">Locked</h5>
                                                <h2 id="lockedLicenses" class="display-6 text-white">0</h2>
                                            </div>
                                            <i class="bi bi-lock-fill display-6" style="color: #f72585;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="card-title text-muted mb-2">Expired</h5>
                                                <h2 id="expiredLicenses" class="display-6 text-white">0</h2>
                                            </div>
                                            <i class="bi bi-clock-fill display-6" style="color: #fbbf24;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i> Recent Licenses</h5>
                                        <button class="btn btn-sm btn-primary-custom" onclick="loadLicenses()">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-dark-custom">
                                                <thead>
                                                    <tr>
                                                        <th>License Key</th>
                                                        <th>Status</th>
                                                        <th>Created</th>
                                                        <th>Expires</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recentLicenses">
                                                    <tr>
                                                        <td colspan="5" class="text-center py-4">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                            <p class="mt-2 mb-0">Loading licenses...</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manage Licenses -->
                    <div id="licensesSection" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-key me-2"></i> All Licenses</h5>
                                <div class="input-group" style="width: 300px;">
                                    <input type="text" id="searchLicense" class="form-control" placeholder="Search licenses...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchLicenses()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-dark-custom">
                                        <thead>
                                            <tr>
                                                <th>License Key</th>
                                                <th>HWID</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Expires</th>
                                                <th>Last Check</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="allLicenses">
                                            <tr>
                                                <td colspan="7" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 mb-0">Loading licenses...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create License -->
                    <div id="createLicenseSection" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i> Create New License</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="createLicenseForm">
                                            <div class="mb-3">
                                                <label for="daysValid" class="form-label">Validity Period (days)</label>
                                                <input type="number" class="form-control" id="daysValid" value="30" min="1" max="365" required>
                                                <div class="form-text">License will expire after this many days</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="note" class="form-label">Note (optional)</label>
                                                <textarea class="form-control" id="note" rows="3" placeholder="Add description or note for this license..."></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary-custom w-100">
                                                <i class="bi bi-plus-circle me-2"></i> Generate License Key
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Recently Created</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="createdLicenses" class="list-group">
                                            <div class="text-center py-4">
                                                <p class="text-muted">No licenses created yet</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Keys -->
                    <div id="apiKeysSection" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-terminal me-2"></i> API Keys Management</h5>
                                <button class="btn btn-sm btn-primary-custom" onclick="showCreateApiKeyModal()">
                                    <i class="bi bi-plus me-1"></i> Create New API Key
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <strong><i class="bi bi-exclamation-triangle me-2"></i> Important:</strong> 
                                    API keys are used to authenticate API requests. Keep them secret and never expose in client-side code!
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark-custom">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>API Key</th>
                                                <th>Permissions</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="apiKeysList">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 mb-0">Loading API keys...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Client API -->
                    <div id="clientApiSection" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i> API Documentation</h5>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="mb-3">API Base URL:</h6>
                                        <code id="baseApiUrl" class="bg-dark text-light p-2 rounded d-block mb-4"></code>
                                        
                                        <h6 class="mt-4 mb-3"><i class="bi bi-check-circle me-2"></i> 1. Validate License (Activation)</h6>
                                        <pre><code>POST /api/client/validate
Content-Type: application/json

{
    "license_key": "LIC-XXXX-XXXX-XXXX",
    "hwid": "device_unique_id",
    "device_info": "Android Device Info"
}

Response:
{
    "valid": true/false,
    "message": "Status message",
    "expires_at": "2024-12-31T23:59:59"
}</code></pre>

                                        <h6 class="mt-4 mb-3"><i class="bi bi-search me-2"></i> 2. Check License Status</h6>
                                        <pre><code>POST /api/client/check
Content-Type: application/json

{
    "license_key": "LIC-XXXX-XXXX-XXXX",
    "hwid": "device_unique_id"
}</code></pre>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-terminal me-2"></i> Shell Script Example (Android)</h5>
                                    </div>
                                    <div class="card-body">
                                        <pre><code>#!/system/bin/sh

# Configuration
API_URL="YOUR_REPLIT_URL/api/client/validate"
LICENSE_KEY="YOUR_LICENSE_KEY"
HWID=$(getprop ro.serialno)  # Or use other unique device ID

# Validate license
response=$(curl -s -X POST "$API_URL" \
    -H "Content-Type: application/json" \
    -d "{\"license_key\":\"$LICENSE_KEY\",\"hwid\":\"$HWID\",\"device_info\":\"Android \$(getprop ro.build.version.release)\"}")

# Parse response
valid=$(echo $response | grep -o '"valid":[^,]*' | cut -d: -f2)
message=$(echo $response | grep -o '"message":"[^"]*"' | cut -d'"' -f4)

if [ "$valid" = "true" ]; then
    echo "✓ License valid: $message"
    # Your app logic here
else
    echo "✗ License invalid: $message"
    exit 1
fi</code></pre>

                                        <div class="mt-4">
                                            <h6><i class="bi bi-play-circle me-2"></i> Test API</h6>
                                            <div class="row g-2 mb-3">
                                                <div class="col-md-6">
                                                    <input type="text" id="testLicenseKey" class="form-control" placeholder="License Key">
                                                </div>
                                                <div class="col-md-6">
                                                    <input type="text" id="testHWID" class="form-control" placeholder="HWID (test123)">
                                                </div>
                                            </div>
                                            <button class="btn btn-primary-custom w-100" onclick="testClientAPI()">
                                                <i class="bi bi-play me-2"></i> Test Validation
                                            </button>
                                            <div id="testResult" class="mt-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="actionModalBody">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-custom" id="actionModalConfirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createApiKeyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New API Key</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="apiKeyName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="apiKeyName" placeholder="e.g., Production Server" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-custom" onclick="createApiKey()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        let API_BASE = window.location.origin;
        let API_KEY = '';
        let currentLicenseAction = null;
        let currentLicenseKey = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('apiEndpoint').textContent = API_BASE;
            document.getElementById('baseApiUrl').textContent = API_BASE;
            
            // Check if already logged in (for demo)
            const savedApiKey = localStorage.getItem('license_admin_api_key');
            if (savedApiKey) {
                API_KEY = savedApiKey;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainSections').style.display = 'block';
                loadDashboard();
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Get first API key
                    const apiKeys = await fetchApiKeys();
                    if (apiKeys.length > 0) {
                        API_KEY = apiKeys[0].key;
                        localStorage.setItem('license_admin_api_key', API_KEY);
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('mainSections').style.display = 'block';
                        loadDashboard();
                        showToast('Login successful!', 'success');
                    }
                } else {
                    showToast('Login failed: ' + data.message, 'danger');
                }
            } catch (error) {
                showToast('Login error: ' + error.message, 'danger');
            }
        });

        // Helper functions
        async function fetchApiKeys() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/apikeys`, {
                    headers: {'X-API-Key': API_KEY}
                });
                const data = await response.json();
                return data.api_keys || [];
            } catch (error) {
                console.error('Error fetching API keys:', error);
                return [];
            }
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove after hide
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toast);
            });
        }

        // Section navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.style.display = 'none';
            });
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected section
            document.getElementById(`${sectionId}Section`).style.display = 'block';
            document.getElementById('sectionTitle').textContent = 
                sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
            
            // Load data if needed
            if (sectionId === 'dashboard') {
                loadDashboard();
            } else if (sectionId === 'licenses') {
                loadAllLicenses();
            } else if (sectionId === 'apiKeys') {
                loadApiKeys();
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/stats`, {
                    headers: {'X-API-Key': API_KEY}
                });
                const data = await response.json();
                
                document.getElementById('totalLicenses').textContent = data.total_licenses || 0;
                document.getElementById('activeLicenses').textContent = data.active_licenses || 0;
                document.getElementById('lockedLicenses').textContent = data.locked_licenses || 0;
                document.getElementById('expiredLicenses').textContent = data.expired_licenses || 0;
                
                // Load recent licenses
                loadRecentLicenses();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Failed to load dashboard data', 'danger');
            }
        }

        async function loadRecentLicenses() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/licenses`, {
                    headers: {'X-API-Key': API_KEY}
                });
                const data = await response.json();
                
                const tbody = document.getElementById('recentLicenses');
                tbody.innerHTML = '';
                
                const recentLicenses = data.licenses ? data.licenses.slice(0, 10) : [];
                
                if (recentLicenses.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <p class="text-muted">No licenses found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                recentLicenses.forEach(license => {
                    const statusClass = license.is_locked ? 'status-locked' : 
                                      (license.status === 'active' ? 'status-active' : 'status-expired');
                    const statusText = license.is_locked ? 'Locked' : 
                                     (license.status === 'active' ? 'Active' : 'Expired');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><code class="license-key">${license.license_key}</code></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(license.created_at)}</td>
                        <td>${license.expires_at ? formatDate(license.expires_at) : 'Never'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewLicense('${license.license_key}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="showResetModal('${license.license_key}')">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('${license.license_key}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading licenses:', error);
                showToast('Failed to load licenses', 'danger');
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // License actions
        function showResetModal(licenseKey) {
            currentLicenseKey = licenseKey;
            currentLicenseAction = 'reset';
            
            document.getElementById('actionModalTitle').textContent = 'Reset License';
            document.getElementById('actionModalBody').innerHTML = `
                <p>Are you sure you want to reset license <code>${licenseKey}</code>?</p>
                <p class="text-warning">This will clear HWID binding and allow activation on a new device.</p>
            `;
            document.getElementById('actionModalConfirm').textContent = 'Reset License';
            
            const modal = new bootstrap.Modal(document.getElementById('actionModal'));
            modal.show();
        }

        function showDeleteModal(licenseKey) {
            currentLicenseKey = licenseKey;
            currentLicenseAction = 'delete';
            
            document.getElementById('actionModalTitle').textContent = 'Delete License';
            document.getElementById('actionModalBody').innerHTML = `
                <p class="text-danger">Are you sure you want to delete license <code>${licenseKey}</code>?</p>
                <p class="text-danger"><strong>This action cannot be undone!</strong></p>
            `;
            document.getElementById('actionModalConfirm').textContent = 'Delete License';
            
            const modal = new bootstrap.Modal(document.getElementById('actionModal'));
            modal.show();
        }

        // Confirm action
        document.getElementById('actionModalConfirm').addEventListener('click', async () => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('actionModal'));
            
            let endpoint = '';
            switch (currentLicenseAction) {
                case 'reset':
                    endpoint = '/api/admin/licenses/reset';
                    break;
                case 'delete':
                    endpoint = '/api/admin/licenses/delete';
                    break;
                case 'lock':
                    endpoint = '/api/admin/licenses/lock';
                    break;
                case 'revoke':
                    endpoint = '/api/admin/licenses/revoke';
                    break;
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({license_key: currentLicenseKey})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadDashboard();
                    loadAllLicenses();
                } else {
                    showToast(data.message || 'Action failed', 'danger');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'danger');
            }
            
            modal.hide();
        });

        // Refresh functions
        function refreshStats() {
            loadDashboard();
            showToast('Dashboard refreshed', 'info');
        }

        function loadLicenses() {
            loadRecentLicenses();
            showToast('Licenses refreshed', 'info');
        }

        // Logout
        function logout() {
            localStorage.removeItem('license_admin_api_key');
            API_KEY = '';
            document.getElementById('mainSections').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showToast('Logged out successfully', 'info');
        }

        // Create license
        document.getElementById('createLicenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const daysValid = document.getElementById('daysValid').value;
            const note = document.getElementById('note').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/licenses/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({days_valid: daysValid, note: note})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('License created successfully!', 'success');
                    
                    // Add to recent created list
                    const createdList = document.getElementById('createdLicenses');
                    const newItem = document.createElement('div');
                    newItem.className = 'list-group-item bg-dark border-secondary mb-2';
                    newItem.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <div>
                                <code class="license-key">${data.license_key}</code>
                                <small class="d-block text-muted">Expires: ${formatDate(data.expires_at)}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="copyToClipboard('${data.license_key}')">
                                <i class="bi bi-copy"></i>
                            </button>
                        </div>
                    `;
                    createdList.insertBefore(newItem, createdList.firstChild);
                    
                    // Clear form
                    document.getElementById('note').value = '';
                    
                    // Refresh dashboard
                    loadDashboard();
                } else {
                    showToast('Failed to create license: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'danger');
            }
        });

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            });
        }

        // Test client API
        async function testClientAPI() {
            const licenseKey = document.getElementById('testLicenseKey').value;
            const hwid = document.getElementById('testHWID').value || 'test123';
            
            if (!licenseKey) {
                showToast('Please enter a license key', 'warning');
                return;
            }
            
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = `
                <div class="alert alert-info">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Testing license validation...
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/client/validate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        license_key: licenseKey,
                        hwid: hwid,
                        device_info: 'Test Device'
                    })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    testResult.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Success!</strong> ${data.message}
                            ${data.expires_at ? `<br>Expires: ${formatDate(data.expires_at)}` : ''}
                        </div>
                    `;
                } else {
                    testResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            <strong>Failed!</strong> ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                testResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Initialize dashboard on load
        if (API_KEY) {
            loadDashboard();
        }
    </script>
</body>
</html>
