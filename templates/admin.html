<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #1a1a2e; color: #fff; }
        .login-box { max-width: 400px; margin: 100px auto; }
        .sidebar { background: #162447; }
        .nav-link { color: #aaa; }
        .nav-link.active { color: #fff; background: #1f4068; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Section -->
        <div id="loginSection" class="login-box card shadow">
            <div class="card-header bg-primary">
                <h4 class="mb-0">License Admin - Login</h4>
            </div>
            <div class="card-body bg-dark">
                <div class="alert alert-info">
                    <strong>Default credentials:</strong><br>
                    Username: <code>admin</code><br>
                    Password: <code>admin123</code>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label>Username</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Password</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        Login
                    </button>
                </form>
                <hr>
                <div class="text-center">
                    <button class="btn btn-sm btn-success" onclick="testLogin()">
                        Test Auto-Login (for testing)
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Panel (hidden) -->
        <div id="mainPanel" style="display: none;">
            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <div class="col-md-3 sidebar p-3">
                        <h4>License Admin</h4>
                        <hr>
                        <button class="btn btn-dark w-100 mb-2" onclick="showSection('dashboard')">Dashboard</button>
                        <button class="btn btn-dark w-100 mb-2" onclick="showSection('create')">Create License</button>
                        <button class="btn btn-dark w-100 mb-2" onclick="showSection('manage')">Manage Licenses</button>
                        <button class="btn btn-dark w-100 mb-2" onclick="showSection('apikeys')">API Keys</button>
                        <hr>
                        <button class="btn btn-danger w-100" onclick="logout()">Logout</button>
                    </div>

                    <!-- Main Content -->
                    <div class="col-md-9 p-4">
                        <h3 id="sectionTitle">Dashboard</h3>
                        <hr>

                        <!-- Dashboard -->
                        <div id="dashboardSection">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white p-3">
                                        <h5>Total Licenses</h5>
                                        <h2 id="totalCount">0</h2>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white p-3">
                                        <h5>Active</h5>
                                        <h2 id="activeCount">0</h2>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white p-3">
                                        <h5>Locked</h5>
                                        <h2 id="lockedCount">0</h2>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white p-3">
                                        <h5>Expired</h5>
                                        <h2 id="expiredCount">0</h2>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h5>Recent Licenses</h5>
                                <div class="table-responsive">
                                    <table class="table table-dark">
                                        <thead>
                                            <tr>
                                                <th>License Key</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="licenseTable">
                                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Create License -->
                        <div id="createSection" style="display: none;">
                            <div class="card bg-dark p-4">
                                <h5>Create New License</h5>
                                <form id="createForm">
                                    <div class="mb-3">
                                        <label>Days Valid</label>
                                        <input type="number" id="daysValid" class="form-control" value="30" min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label>Note (optional)</label>
                                        <textarea id="licenseNote" class="form-control" rows="2"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Create License</button>
                                </form>
                                <div id="createdResult" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Manage Licenses -->
                        <div id="manageSection" style="display: none;">
                            <div class="card bg-dark p-4">
                                <h5>All Licenses</h5>
                                <div class="mb-3">
                                    <input type="text" id="searchInput" class="form-control" placeholder="Search licenses...">
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark">
                                        <thead>
                                            <tr>
                                                <th>License Key</th>
                                                <th>HWID</th>
                                                <th>Status</th>
                                                <th>Expires</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="allLicensesTable">
                                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- API Keys -->
                        <div id="apikeysSection" style="display: none;">
                            <div class="card bg-dark p-4">
                                <h5>API Keys</h5>
                                <button class="btn btn-success mb-3" onclick="createApiKey()">Create New API Key</button>
                                <div class="table-responsive">
                                    <table class="table table-dark">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>API Key</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="apiKeysTable">
                                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let API_KEY = '';
        let LICENSES = [];

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(API_BASE + '/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Get API keys
                    const apiKeys = await getApiKeys();
                    if (apiKeys.length > 0) {
                        API_KEY = apiKeys[0].key;
                        showMainPanel();
                        loadDashboard();
                        alert('Login successful!');
                    } else {
                        alert('No API keys found. Please check server setup.');
                    }
                } else {
                    alert('Login failed: ' + data.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Test login (for debugging)
        function testLogin() {
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
        }

        // API Helper
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'X-API-Key': API_KEY
            };
            
            const options = {
                method,
                headers
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(API_BASE + endpoint, options);
            return await response.json();
        }

        // Get API Keys
        async function getApiKeys() {
            try {
                const data = await apiRequest('/api/admin/apikeys');
                return data.api_keys || [];
            } catch (error) {
                console.error('Error getting API keys:', error);
                return [];
            }
        }

        // Show main panel
        function showMainPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            ['dashboard', 'create', 'manage', 'apikeys'].forEach(s => {
                document.getElementById(s + 'Section').style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(section + 'Section').style.display = 'block';
            document.getElementById('sectionTitle').textContent = 
                section.charAt(0).toUpperCase() + section.slice(1);
            
            // Load data
            if (section === 'dashboard') loadDashboard();
            if (section === 'manage') loadAllLicenses();
            if (section === 'apikeys') loadApiKeys();
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                // Load stats
                const stats = await apiRequest('/api/admin/stats');
                document.getElementById('totalCount').textContent = stats.total_licenses || 0;
                document.getElementById('activeCount').textContent = stats.active_licenses || 0;
                document.getElementById('lockedCount').textContent = stats.locked_licenses || 0;
                document.getElementById('expiredCount').textContent = stats.expired_licenses || 0;
                
                // Load licenses
                const licenses = await apiRequest('/api/admin/licenses');
                LICENSES = licenses.licenses || [];
                
                const table = document.getElementById('licenseTable');
                table.innerHTML = '';
                
                LICENSES.slice(0, 10).forEach(license => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td><code>${license.license_key}</code></td>
                        <td><span class="badge ${license.status === 'active' ? 'bg-success' : 'bg-danger'}">${license.status}</span></td>
                        <td>${new Date(license.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="copyLicense('${license.license_key}')">Copy</button>
                            <button class="btn btn-sm btn-warning" onclick="resetLicense('${license.license_key}')">Reset</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Create license
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const daysValid = document.getElementById('daysValid').value;
            const note = document.getElementById('licenseNote').value;
            
            try {
                const result = await apiRequest('/api/admin/licenses/create', 'POST', {
                    days_valid: daysValid,
                    note: note
                });
                
                if (result.success) {
                    document.getElementById('createdResult').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Success!</strong><br>
                            License Key: <code>${result.license_key}</code><br>
                            Expires: ${new Date(result.expires_at).toLocaleDateString()}
                            <button class="btn btn-sm btn-success ms-2" onclick="copyLicense('${result.license_key}')">Copy</button>
                        </div>
                    `;
                    loadDashboard();
                } else {
                    document.getElementById('createdResult').innerHTML = `
                        <div class="alert alert-danger">Error: ${result.error}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('createdResult').innerHTML = `
                    <div class="alert alert-danger">Error: ${error.message}</div>
                `;
            }
        });

        // Load all licenses
        async function loadAllLicenses() {
            try {
                const licenses = await apiRequest('/api/admin/licenses');
                const table = document.getElementById('allLicensesTable');
                table.innerHTML = '';
                
                (licenses.licenses || []).forEach(license => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td><code>${license.license_key}</code></td>
                        <td><small>${license.hwid || 'Not activated'}</small></td>
                        <td><span class="badge ${license.status === 'active' ? 'bg-success' : license.status === 'locked' ? 'bg-warning' : 'bg-danger'}">${license.status}</span></td>
                        <td>${license.expires_at ? new Date(license.expires_at).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="copyLicense('${license.license_key}')">Copy</button>
                            <button class="btn btn-sm btn-warning" onclick="resetLicense('${license.license_key}')">Reset</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLicense('${license.license_key}')">Delete</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading licenses:', error);
            }
        }

        // Load API keys
        async function loadApiKeys() {
            try {
                const keys = await apiRequest('/api/admin/apikeys');
                const table = document.getElementById('apiKeysTable');
                table.innerHTML = '';
                
                (keys.api_keys || []).forEach(key => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${key.name}</td>
                        <td><code>${key.key_masked || key.key.substring(0, 8) + '...'}</code></td>
                        <td>${new Date(key.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="copyApiKey('${key.key}')">Copy</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        // Action functions
        function copyLicense(key) {
            navigator.clipboard.writeText(key);
            alert('Copied: ' + key);
        }

        function copyApiKey(key) {
            navigator.clipboard.writeText(key);
            alert('API Key copied!');
        }

        async function resetLicense(licenseKey) {
            if (confirm('Reset this license? This will clear HWID binding.')) {
                const result = await apiRequest('/api/admin/licenses/reset', 'POST', {
                    license_key: licenseKey
                });
                
                if (result.success) {
                    alert('License reset successfully!');
                    loadDashboard();
                    loadAllLicenses();
                } else {
                    alert('Error: ' + result.message);
                }
            }
        }

        async function deleteLicense(licenseKey) {
            if (confirm('DELETE this license permanently?')) {
                const result = await apiRequest('/api/admin/licenses/delete', 'POST', {
                    license_key: licenseKey
                });
                
                if (result.success) {
                    alert('License deleted!');
                    loadDashboard();
                    loadAllLicenses();
                } else {
                    alert('Error: ' + result.message);
                }
            }
        }

        function createApiKey() {
            const name = prompt('Enter API Key name:');
            if (name) {
                apiRequest('/api/admin/apikeys/create', 'POST', { name: name })
                    .then(result => {
                        if (result.success) {
                            alert('API Key created!\n\n' + result.api_key + '\n\nSave this key now!');
                            loadApiKeys();
                        } else {
                            alert('Error: ' + result.message);
                        }
                    });
            }
        }

        function logout() {
            if (confirm('Logout?')) {
                API_KEY = '';
                document.getElementById('mainPanel').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        // Auto-test on load
        window.addEventListener('load', function() {
            console.log('Admin panel loaded at:', API_BASE);
            
            // Test if API is reachable
            fetch(API_BASE + '/api/admin/stats')
                .then(response => {
                    console.log('API test response:', response.status);
                })
                .catch(error => {
                    console.error('API not reachable:', error);
                });
        });
    </script>
</body>
</html>
