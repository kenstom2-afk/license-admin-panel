<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #1a1a2e;
            --light: #f8f9fa;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .navbar-brand {
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card-custom {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            transition: transform 0.3s ease;
        }
        
        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .table-custom {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table-custom th {
            background: rgba(30, 41, 59, 0.9);
            border: none;
            color: #94a3b8;
            font-weight: 600;
            padding: 15px;
        }
        
        .table-custom td {
            border-color: rgba(255, 255, 255, 0.1);
            padding: 12px 15px;
            vertical-align: middle;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .status-locked {
            background: rgba(247, 37, 133, 0.2);
            color: #f72585;
            border: 1px solid rgba(247, 37, 133, 0.3);
        }
        
        .license-key {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid var(--success);
        }
        
        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
        }
        
        .form-control, .form-select {
            background-color: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            border-radius: 8px;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #334155;
            border-color: var(--primary);
            color: #e2e8f0;
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        pre {
            background: #0f172a;
            color: #7dd3fc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 0.9em;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        #loginSection {
            max-width: 450px;
            margin: 80px auto;
        }
        
        #mainSections {
            display: none;
        }
        
        .setup-box {
            border: 2px dashed #4cc9f0;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            background: rgba(76, 201, 240, 0.1);
        }
        
        .debug-info {
            font-size: 0.85em;
            color: #94a3b8;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark border-bottom border-secondary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-lock-fill me-2"></i>License Admin Panel
            </a>
            <div class="d-flex">
                <span class="badge bg-success me-3" id="apiStatus">API: Checking...</span>
                <button class="btn btn-sm btn-outline-light" onclick="checkSystemStatus()">
                    <i class="bi bi-heart-pulse"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid mt-4">
        <!-- Login Section -->
        <div id="loginSection">
            <div class="card card-custom">
                <div class="card-header" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                    <h4 class="mb-0 text-white"><i class="bi bi-lock-fill me-2"></i> Admin Login</h4>
                </div>
                <div class="card-body">
                    <!-- System Status -->
                    <div class="setup-box mb-3">
                        <h6><i class="bi bi-info-circle me-2"></i> System Status</h6>
                        <div class="debug-info" id="systemStatus">
                            Checking system status...
                        </div>
                        <button class="btn btn-sm btn-outline-info mt-2 w-100" onclick="checkSystemStatus()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh Status
                        </button>
                    </div>
                    
                    <!-- Setup Warning -->
                    <div class="alert alert-warning" id="setupAlert" style="display: none;">
                        <strong><i class="bi bi-exclamation-triangle me-2"></i> Setup Required:</strong>
                        <span id="setupMessage"></span>
                        <button class="btn btn-sm btn-warning mt-2" onclick="fixSetupIssue()">
                            <i class="bi bi-tools me-1"></i> Fix Automatically
                        </button>
                    </div>
                    
                    <!-- Login Form -->
                    <div class="alert alert-info">
                        <strong><i class="bi bi-info-circle me-2"></i> Default Credentials:</strong><br>
                        Username: <code>admin</code><br>
                        Password: <code>admin123</code>
                    </div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" value="admin" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" value="admin123" required>
                        </div>
                        <button type="submit" class="btn btn-primary-custom w-100">
                            <i class="bi bi-box-arrow-in-right me-2"></i> Login
                        </button>
                    </form>
                    
                    <!-- Quick Actions -->
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-success me-2" onclick="quickLogin()">
                            <i class="bi bi-lightning-fill me-1"></i> Quick Login
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="showDebugTools()">
                            <i class="bi bi-bug me-1"></i> Debug Tools
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Debug Tools (hidden) -->
            <div class="card card-custom mt-3" id="debugTools" style="display: none;">
                <div class="card-body">
                    <h6><i class="bi bi-tools me-2"></i> Debug Tools</h6>
                    <div class="btn-group w-100">
                        <button class="btn btn-sm btn-outline-info" onclick="testApiConnection()">
                            Test API
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="createApiKeyManually()">
                            Create API Key
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="resetDatabase()">
                            Reset DB
                        </button>
                    </div>
                    <div id="debugResult" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard (hidden initially) -->
        <div id="mainSections">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-3 mb-4">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="mb-3"><i class="bi bi-menu-button-wide me-2"></i> Menu</h5>
                            <div class="list-group list-group-flush">
                                <button class="list-group-item list-group-item-action bg-transparent text-white border-secondary" onclick="showSection('dashboard')">
                                    <i class="bi bi-speedometer2 me-2"></i> Dashboard
                                </button>
                                <button class="list-group-item list-group-item-action bg-transparent text-white border-secondary" onclick="showSection('create')">
                                    <i class="bi bi-plus-circle me-2"></i> Create License
                                </button>
                                <button class="list-group-item list-group-item-action bg-transparent text-white border-secondary" onclick="showSection('manage')">
                                    <i class="bi bi-key me-2"></i> Manage Licenses
                                </button>
                                <button class="list-group-item list-group-item-action bg-transparent text-white border-secondary" onclick="showSection('apikeys')">
                                    <i class="bi bi-terminal me-2"></i> API Keys
                                </button>
                                <button class="list-group-item list-group-item-action bg-transparent text-white border-secondary" onclick="showSection('clientapi')">
                                    <i class="bi bi-phone me-2"></i> Client API
                                </button>
                            </div>
                            <hr class="border-secondary">
                            <div class="text-center">
                                <button class="btn btn-danger w-100" onclick="logout()">
                                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Card -->
                    <div class="card card-custom mt-4">
                        <div class="card-body">
                            <h6><i class="bi bi-graph-up me-2"></i> Quick Stats</h6>
                            <div class="row text-center mt-3">
                                <div class="col-6 mb-3">
                                    <div class="text-primary fw-bold fs-4" id="statTotal">0</div>
                                    <small class="text-muted">Total</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="text-success fw-bold fs-4" id="statActive">0</div>
                                    <small class="text-muted">Active</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <!-- Dashboard -->
                    <div id="dashboardSection">
                        <div class="card card-custom">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i> Dashboard</h5>
                                <button class="btn btn-sm btn-primary-custom" onclick="loadStats()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="card bg-primary text-white p-3">
                                            <h6>Total Licenses</h6>
                                            <h3 id="totalLicenses">0</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="card bg-success text-white p-3">
                                            <h6>Active</h6>
                                            <h3 id="activeLicenses">0</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="card bg-warning text-white p-3">
                                            <h6>Locked</h6>
                                            <h3 id="lockedLicenses">0</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="card bg-danger text-white p-3">
                                            <h6>Expired</h6>
                                            <h3 id="expiredLicenses">0</h3>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6 class="mb-3"><i class="bi bi-clock-history me-2"></i> Recent Licenses</h6>
                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>License Key</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Expires</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentLicenses">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status"></div>
                                                    <p class="mt-2 mb-0">Loading licenses...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create License -->
                    <div id="createSection" style="display: none;">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i> Create New License</h5>
                            </div>
                            <div class="card-body">
                                <form id="createForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="daysValid" class="form-label">Validity Period (days)</label>
                                            <input type="number" class="form-control" id="daysValid" value="30" min="1" max="3650" required oninput="validateDays(this)">
                                            <div class="form-text">License will expire after this many days (1-3650)</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="licenseNote" class="form-label">Note (optional)</label>
                                            <textarea class="form-control" id="licenseNote" rows="1" placeholder="Add description..."></textarea>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary-custom w-100">
                                        <i class="bi bi-plus-circle me-2"></i> Generate License Key
                                    </button>
                                </form>
                                <div id="createResult" class="mt-4"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Manage Licenses -->
                    <div id="manageSection" style="display: none;">
                        <div class="card card-custom">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-key me-2"></i> Manage Licenses</h5>
                                <div class="input-group" style="width: 300px;">
                                    <input type="text" id="searchInput" class="form-control" placeholder="Search licenses...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchLicenses()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>License Key</th>
                                                <th>HWID</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Expires</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="allLicensesTable">
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status"></div>
                                                    <p class="mt-2 mb-0">Loading licenses...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Keys -->
                    <div id="apikeysSection" style="display: none;">
                        <div class="card card-custom">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-terminal me-2"></i> API Keys Management</h5>
                                <button class="btn btn-sm btn-primary-custom" onclick="createApiKey()">
                                    <i class="bi bi-plus me-1"></i> Create API Key
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-key me-2"></i> Current API Key:</strong>
                                    <code class="license-key d-block mt-2" id="currentApiKey">Loading...</code>
                                    <button class="btn btn-sm btn-success mt-2" onclick="copyCurrentApiKey()">
                                        <i class="bi bi-copy me-1"></i> Copy to Clipboard
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>API Key</th>
                                                <th>Permissions</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="apiKeysTable">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status"></div>
                                                    <p class="mt-2 mb-0">Loading API keys...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Client API -->
                    <div id="clientapiSection" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card card-custom">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i> API Documentation</h5>
                                    </div>
                                    <div class="card-body">
                                        <h6>API Base URL:</h6>
                                        <code class="license-key d-block mb-3 p-2" id="baseApiUrl">Loading...</code>
                                        
                                        <h6 class="mt-4">1. Validate License (Activation)</h6>
                                        <pre><code>POST /api/client/validate
Content-Type: application/json

{
    "license_key": "DK-XXXX-XXXX",
    "hwid": "device_unique_id",
    "device_info": "Android Device Info"
}

Response:
{
    "valid": true/false,
    "message": "Status message",
    "expires_at": "2024-12-31T23:59:59"
}</code></pre>

                                        <h6 class="mt-4">2. Check License Status</h6>
                                        <pre><code>POST /api/client/check
Content-Type: application/json

{
    "license_key": "DK-XXXX-XXXX",
    "hwid": "device_unique_id"
}</code></pre>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card card-custom">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-terminal me-2"></i> Test Client API</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="testLicenseKey" class="form-label">License Key</label>
                                            <input type="text" id="testLicenseKey" class="form-control" placeholder="Enter license key">
                                        </div>
                                        <div class="mb-3">
                                            <label for="testHWID" class="form-label">HWID (Device ID)</label>
                                            <input type="text" id="testHWID" class="form-control" value="test-device-123">
                                        </div>
                                        <button class="btn btn-primary-custom w-100 mb-3" onclick="testClientAPI()">
                                            <i class="bi bi-play-fill me-2"></i> Test License Validation
                                        </button>
                                        <div id="testResult"></div>
                                        
                                        <hr class="my-4">
                                        <h6><i class="bi bi-android me-2"></i> Shell Script Example</h6>
                                        <pre><code>#!/system/bin/sh
API_URL="''' + window.location.origin + '''/api/client/validate"
LICENSE_KEY="YOUR_LICENSE_KEY"
HWID=$(getprop ro.serialno)

response=$(curl -s -X POST "$API_URL" \
    -H "Content-Type: application/json" \
    -d "{\"license_key\":\"$LICENSE_KEY\",\"hwid\":\"$HWID\",\"device_info\":\"Android Device\"}")

valid=$(echo $response | grep -o '"valid":[^,]*' | cut -d: -f2)
if [ "$valid" = "true" ]; then
    echo "✓ License valid"
    exit 0
else
    echo "✗ License invalid"
    exit 1
fi</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let API_KEY = '';
        let LICENSES = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('baseApiUrl').textContent = API_BASE;
            
            // Check system status on load
            checkSystemStatus();
            
            // Check for saved API key
            const savedApiKey = localStorage.getItem('license_admin_api_key');
            if (savedApiKey) {
                API_KEY = savedApiKey;
                document.getElementById('currentApiKey').textContent = savedApiKey;
                // Verify API key is still valid
                verifyApiKey(savedApiKey);
            }
        });

        // ============== VALIDATION FUNCTIONS ==============
        
        // Validate days input
        function validateDays(input) {
            const value = parseInt(input.value) || 30;
            if (value < 1) input.value = 1;
            if (value > 3650) input.value = 3650;
        }

        // ============== SYSTEM SETUP FUNCTIONS ==============
        
        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch(API_BASE + '/api/admin/debug');
                const data = await response.json();
                
                document.getElementById('systemStatus').innerHTML = `
                    <div class="mb-1">• Database Tables: ${data.database_tables.join(', ')}</div>
                    <div class="mb-1">• Admin Users: ${data.counts.admin_users}</div>
                    <div class="mb-1">• API Keys: ${data.counts.api_keys}</div>
                    <div class="mb-1">• Licenses: ${data.counts.licenses}</div>
                    ${data.api_key_info ? `<div>• API Key: ${data.api_key_info.key_masked}</div>` : ''}
                `;
                
                // Update API status badge
                if (data.counts.api_keys > 0) {
                    document.getElementById('apiStatus').className = 'badge bg-success me-3';
                    document.getElementById('apiStatus').textContent = 'API: Ready';
                    document.getElementById('setupAlert').style.display = 'none';
                } else {
                    document.getElementById('apiStatus').className = 'badge bg-danger me-3';
                    document.getElementById('apiStatus').textContent = 'API: No Keys';
                    document.getElementById('setupMessage').textContent = 'No API keys found in database.';
                    document.getElementById('setupAlert').style.display = 'block';
                }
                
                return data;
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 
                    `<div class="text-danger">❌ Error: ${error.message}</div>`;
                document.getElementById('apiStatus').className = 'badge bg-danger me-3';
                document.getElementById('apiStatus').textContent = 'API: Offline';
                return null;
            }
        }

        // Fix setup issues automatically
        async function fixSetupIssue() {
            try {
                const response = await fetch(API_BASE + '/api/admin/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'create_key' })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('✅ API key created successfully!', 'success');
                    // Auto-login with new key
                    quickLogin();
                } else {
                    showToast('❌ Failed to create API key', 'danger');
                }
                checkSystemStatus();
            } catch (error) {
                showToast('Error: ' + error.message, 'danger');
            }
        }

        // Quick login (auto setup)
        async function quickLogin() {
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            
            // Check system first
            const status = await checkSystemStatus();
            if (status && status.counts.api_keys === 0) {
                // No API keys, create one first
                await fixSetupIssue();
            } else {
                // Submit login form
                document.getElementById('loginForm').dispatchEvent(new Event('submit'));
            }
        }

        // Show debug tools
        function showDebugTools() {
            const debugTools = document.getElementById('debugTools');
            debugTools.style.display = debugTools.style.display === 'none' ? 'block' : 'none';
        }

        // Test API connection
        async function testApiConnection() {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = '<div class="text-info">Testing API connection...</div>';
            
            try {
                const response = await fetch(API_BASE + '/api/admin/debug');
                const data = await response.json();
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>✅ API Connection Successful!</strong><br>
                        Status: ${data.status}<br>
                        Message: ${data.message}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>❌ API Connection Failed!</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        // Create API key manually
        async function createApiKeyManually() {
            const name = prompt('Enter API Key name:', 'Manual Key');
            if (!name) return;
            
            try {
                const response = await fetch(API_BASE + '/api/admin/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'create_key', name: name })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`✅ API Key Created!\n\n${data.api_key}\n\nSave this key!`);
                    copyToClipboard(data.api_key);
                    checkSystemStatus();
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'danger');
            }
        }

        // ============== LOGIN & AUTH FUNCTIONS ==============
        
        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(API_BASE + '/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Save API key
                    API_KEY = data.api_key;
                    localStorage.setItem('license_admin_api_key', API_KEY);
                    
                    // Update current API key display
                    document.getElementById('currentApiKey').textContent = data.api_key;
                    
                    // Show main panel
                    showMainPanel();
                    loadStats();
                    showToast('✅ Login successful!', 'success');
                } else {
                    showToast('❌ Login failed: ' + data.message, 'danger');
                }
            } catch (error) {
                showToast('⚠️ Login error: ' + error.message, 'danger');
            }
        });

        // Verify API key
        async function verifyApiKey(apiKey) {
            try {
                const response = await fetch(API_BASE + '/api/admin/stats', {
                    headers: { 'X-API-Key': apiKey }
                });
                
                if (response.ok) {
                    API_KEY = apiKey;
                    document.getElementById('currentApiKey').textContent = apiKey;
                    showMainPanel();
                    loadStats();
                } else {
                    localStorage.removeItem('license_admin_api_key');
                    showToast('Session expired. Please login again.', 'warning');
                }
            } catch (error) {
                localStorage.removeItem('license_admin_api_key');
            }
        }

        // ============== MAIN PANEL FUNCTIONS ==============
        
        // Show main panel
        function showMainPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSections').style.display = 'block';
            showSection('dashboard');
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            ['dashboard', 'create', 'manage', 'apikeys', 'clientapi'].forEach(s => {
                document.getElementById(s + 'Section').style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(section + 'Section').style.display = 'block';
            
            // Load data if needed
            if (section === 'dashboard') {
                loadDashboard();
            } else if (section === 'manage') {
                loadAllLicenses();
            } else if (section === 'apikeys') {
                loadApiKeys();
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const stats = await apiRequest('/api/admin/stats');
                if (!stats) return;
                
                document.getElementById('totalLicenses').textContent = stats.total_licenses || 0;
                document.getElementById('activeLicenses').textContent = stats.active_licenses || 0;
                document.getElementById('lockedLicenses').textContent = stats.locked_licenses || 0;
                document.getElementById('expiredLicenses').textContent = stats.expired_licenses || 0;
                document.getElementById('statTotal').textContent = stats.total_licenses || 0;
                document.getElementById('statActive').textContent = stats.active_licenses || 0;
                
                // Load recent licenses
                loadRecentLicenses();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // API Helper
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'X-API-Key': API_KEY
            };
            
            const options = {
                method,
                headers
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(API_BASE + endpoint, options);
            if (response.status === 401) {
                showToast('Invalid API key', 'danger');
                logout();
                return null;
            }
            return await response.json();
        }

        // Load recent licenses
        async function loadRecentLicenses() {
            try {
                const licenses = await apiRequest('/api/admin/licenses');
                if (!licenses) return;
                
                LICENSES = licenses.licenses || [];
                const table = document.getElementById('recentLicenses');
                table.innerHTML = '';
                
                const recent = LICENSES.slice(0, 10);
                
                if (recent.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" class="text-center py-4">No licenses found</td></tr>';
                    return;
                }
                
                recent.forEach(license => {
                    const statusClass = license.is_locked ? 'status-locked' : 
                                      (license.status === 'active' ? 'status-active' : 'status-expired');
                    const statusText = license.is_locked ? 'Locked' : 
                                     (license.status === 'active' ? 'Active' : 'Expired');
                    
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td><code class="license-key">${license.license_key}</code></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(license.created_at)}</td>
                        <td>${license.expires_at ? formatDate(license.expires_at) : 'Never'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="copyToClipboard('${license.license_key}')">
                                <i class="bi bi-copy"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="resetLicense('${license.license_key}')">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading licenses:', error);
            }
        }

        // Load all licenses
        async function loadAllLicenses() {
            try {
                const licenses = await apiRequest('/api/admin/licenses');
                if (!licenses) return;
                
                const table = document.getElementById('allLicensesTable');
                table.innerHTML = '';
                
                (licenses.licenses || []).forEach(license => {
                    const statusClass = license.is_locked ? 'status-locked' : 
                                      (license.status === 'active' ? 'status-active' : 'status-expired');
                    const statusText = license.is_locked ? 'Locked' : 
                                     (license.status === 'active' ? 'Active' : 'Expired');
                    
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td><code class="license-key">${license.license_key}</code></td>
                        <td><small>${license.hwid || 'Not activated'}</small></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(license.created_at)}</td>
                        <td>${license.expires_at ? formatDate(license.expires_at) : 'Never'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="copyToClipboard('${license.license_key}')">
                                <i class="bi bi-copy"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="resetLicense('${license.license_key}')">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLicense('${license.license_key}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading all licenses:', error);
            }
        }

        // Load API keys
        async function loadApiKeys() {
            try {
                const keys = await apiRequest('/api/admin/apikeys');
                if (!keys) return;
                
                const table = document.getElementById('apiKeysTable');
                table.innerHTML = '';
                
                (keys.api_keys || []).forEach(key => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${key.name}</td>
                        <td><code>${key.key_masked || key.key.substring(0, 8) + '...'}</code></td>
                        <td>${key.permissions || 'all'}</td>
                        <td>${formatDate(key.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="copyToClipboard('${key.key}')">
                                <i class="bi bi-copy me-1"></i>Copy
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        // Create license - FIXED: Convert days to number
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // FIX: Convert to number
            const daysValid = parseInt(document.getElementById('daysValid').value) || 30;
            const note = document.getElementById('licenseNote').value;
            
            // Validate
            if (daysValid < 1 || daysValid > 3650) {
                showToast('Please enter valid days (1-3650)', 'warning');
                return;
            }
            
            try {
                const result = await apiRequest('/api/admin/licenses/create', 'POST', {
                    days_valid: daysValid,  // Sending as number
                    note: note
                });
                
                if (result?.success) {
                    const resultDiv = document.getElementById('createResult');
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle me-2"></i> License Created Successfully!</h6>
                            <p><strong>License Key:</strong> <code class="license-key">${result.license_key}</code></p>
                            <p><strong>Expires:</strong> ${formatDate(result.expires_at)}</p>
                            <button class="btn btn-sm btn-success" onclick="copyToClipboard('${result.license_key}')">
                                <i class="bi bi-copy me-1"></i>Copy License Key
                            </button>
                        </div>
                    `;
                    loadStats();
                    showToast('✅ License created!', 'success');
                } else {
                    showToast(`❌ Failed: ${result.error || 'Unknown error'}`, 'danger');
                }
            } catch (error) {
                showToast(`⚠️ Error: ${error.message}`, 'danger');
            }
        });

        // Create API key
        async function createApiKey() {
            const name = prompt('Enter API Key name:', 'New API Key');
            if (!name) return;
            
            try {
                const result = await apiRequest('/api/admin/apikeys/create', 'POST', { name: name });
                if (result?.success) {
                    alert(`✅ API Key created!\n\n${result.api_key}\n\nSave this key now - it won't be shown again!`);
                    copyToClipboard(result.api_key);
                    loadApiKeys();
                } else {
                    showToast('Failed to create API key', 'danger');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'danger');
            }
        }

        // Copy current API key
        function copyCurrentApiKey() {
            if (API_KEY) {
                copyToClipboard(API_KEY);
            } else {
                showToast('No API key available', 'warning');
            }
        }

        // Reset license
        async function resetLicense(licenseKey) {
            if (!confirm(`Reset license ${licenseKey}? This will clear HWID binding.`)) return;
            
            try {
                const result = await apiRequest('/api/admin/licenses/reset', 'POST', {
                    license_key: licenseKey
                });
                
                if (result?.success) {
                    showToast('License reset successfully', 'success');
                    loadStats();
                    loadAllLicenses();
                } else {
                    showToast('Failed to reset license', 'danger');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'danger');
            }
        }

        // Delete license
        async function deleteLicense(licenseKey) {
            if (!confirm(`DELETE license ${licenseKey} permanently?`)) return;
            
            try {
                const result = await apiRequest('/api/admin/licenses/delete', 'POST', {
                    license_key: licenseKey
                });
                
                if (result?.success) {
                    showToast('License deleted', 'success');
                    loadStats();
                    loadAllLicenses();
                } else {
                    showToast('Failed to delete license', 'danger');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'danger');
            }
        }

        // Test client API
        async function testClientAPI() {
            const licenseKey = document.getElementById('testLicenseKey').value;
            const hwid = document.getElementById('testHWID').value;
            
            if (!licenseKey) {
                showToast('Please enter a license key', 'warning');
                return;
            }
            
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Testing license validation...
                </div>
            `;
            
            try {
                const response = await fetch(API_BASE + '/api/client/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        license_key: licenseKey,
                        hwid: hwid,
                        device_info: 'Test Device'
                    })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>✅ Success!</strong> ${data.message}<br>
                            ${data.expires_at ? `<small>Expires: ${formatDate(data.expires_at)}</small>` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            <strong>❌ Failed!</strong> ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        <strong>⚠️ Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return dateString;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('✅ Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('❌ Failed to copy', 'danger');
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('license_admin_api_key');
                API_KEY = '';
                document.getElementById('currentApiKey').textContent = '';
                document.getElementById('mainSections').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('username').value = 'admin';
                document.getElementById('password').value = 'admin123';
                checkSystemStatus();
                showToast('Logged out successfully', 'info');
            }
        }

        // On page load, check if already logged in
        if (API_KEY) {
            verifyApiKey(API_KEY);
        }
    </script>
</body>
</html>
